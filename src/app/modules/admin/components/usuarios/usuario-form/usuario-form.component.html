<!-- Page Header -->
<app-page-header
  [title]="isEditMode ? 'Editar Usuario' : 'Nuevo Usuario'"
  [subtitle]="isEditMode ? 'Actualiza la informaci√≥n del usuario seleccionado' : 'Registra un nuevo usuario en el sistema'"
  icon="bi-person-plus"
  actionType="back"
  actionRoute="/admin/usuarios"
  actionText="Volver a Usuarios"
  actionIcon="bi bi-arrow-left"
  primaryColor="#007bff"
  secondaryColor="#0056b3"
  [showAction]="true">
</app-page-header>

<div class="container-fluid">
    <div class="container">

    <!-- Form Card -->
    <div class="form-card">

      <div class="card-body">
        <!-- Loading State -->
        <div *ngIf="loading" class="loading-container">
          <div class="loading-spinner"></div>
          <p class="loading-text">Cargando informaci√≥n del usuario...</p>
        </div>

        <!-- Error State -->
        <div *ngIf="error" class="error-container">
          <div class="error-icon">
            <i class="bi bi-exclamation-triangle"></i>
          </div>
          <h4 class="error-title">Error al cargar</h4>
          <p class="error-message">{{ error }}</p>
          <button class="btn btn-retry" (click)="ngOnInit()">
            <i class="bi bi-arrow-clockwise me-2"></i>
            Reintentar
          </button>
        </div>

        <form [formGroup]="usuarioForm" (ngSubmit)="onSubmit()" *ngIf="!loading">
          <!-- Informaci√≥n Personal -->
          <div class="form-section">
            <div class="section-header">
              <h4 class="section-title">
                <i class="bi bi-person me-2"></i>
                Informaci√≥n Personal
              </h4>
              <p class="section-description">Datos b√°sicos del usuario</p>
            </div>
            
            <div class="row g-4">
              <!-- Nombre -->
              <div class="col-md-6">
                <div class="form-group">
                  <label for="nombre" class="form-label">
                    <i class="bi bi-person-badge me-2"></i>
                    Nombre completo
                    <span class="required">*</span>
                  </label>
                  <input 
                    type="text" 
                    class="form-control form-control-modern" 
                    id="nombre" 
                    formControlName="nombre"
                    placeholder="Ingrese el nombre completo"
                    [ngClass]="{'is-invalid': nombreControl?.invalid && nombreControl?.touched}"
                  >
                  <div class="invalid-feedback" *ngIf="nombreControl?.errors?.['required']">
                    <i class="bi bi-exclamation-circle me-1"></i>
                    El nombre es obligatorio
                  </div>
                  <div class="invalid-feedback" *ngIf="nombreControl?.errors?.['maxlength']">
                    <i class="bi bi-exclamation-circle me-1"></i>
                    El nombre no puede exceder los 100 caracteres
                  </div>
                </div>
              </div>

              <!-- Email -->
              <div class="col-md-6">
                <div class="form-group">
                  <label for="email" class="form-label">
                    <i class="bi bi-envelope me-2"></i>
                    Email
                    <span class="required">*</span>
                  </label>
                  <input 
                    type="email" 
                    class="form-control form-control-modern" 
                    id="email" 
                    formControlName="email"
                    placeholder="usuario@ejemplo.com"
                    [ngClass]="{'is-invalid': emailControl?.invalid && emailControl?.touched}"
                  >
                  <div class="invalid-feedback" *ngIf="emailControl?.errors?.['required']">
                    <i class="bi bi-exclamation-circle me-1"></i>
                    El email es obligatorio
                  </div>
                  <div class="invalid-feedback" *ngIf="emailControl?.errors?.['email']">
                    <i class="bi bi-exclamation-circle me-1"></i>
                    Ingrese un email v√°lido
                  </div>
                </div>
              </div>

              <!-- Tel√©fono -->
              <div class="col-md-6">
                <div class="form-group">
                  <label for="telefono" class="form-label">
                    <i class="bi bi-phone me-2"></i>
                    Tel√©fono
                  </label>
                  <input 
                    type="text" 
                    class="form-control form-control-modern" 
                    id="telefono" 
                    formControlName="telefono"
                    placeholder="987654321"
                    maxlength="9"
                    [ngClass]="{'is-invalid': telefonoControl?.invalid && telefonoControl?.touched}"
                  >
                  <div class="invalid-feedback" *ngIf="telefonoControl?.errors?.['pattern']">
                    <i class="bi bi-exclamation-circle me-1"></i>
                    El tel√©fono debe tener 9 d√≠gitos num√©ricos
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Configuraci√≥n de Acceso -->
          <div class="form-section">
            <div class="section-header">
              <h4 class="section-title">
                <i class="bi bi-shield-check me-2"></i>
                Configuraci√≥n de Acceso
              </h4>
              <p class="section-description">Tipo de usuario y permisos</p>
            </div>
            
            <div class="row g-4">
              <!-- Tipo de Usuario -->
              <div class="col-md-6">
                <div class="form-group">
                  <label for="tipo_usuario" class="form-label">
                    <i class="bi bi-person-gear me-2"></i>
                    Tipo de Usuario
                    <span class="required">*</span>
                  </label>
                  <select 
                    class="form-select form-control-modern" 
                    id="tipo_usuario" 
                    formControlName="tipo_usuario"
                  >
                    <option value="ADMIN">üëë Administrador</option>
                    <option value="IPRESS_ADMIN">üè• Administrador de IPRESS</option>
                    <option value="MEDICO">üë®‚Äç‚öïÔ∏è M√©dico</option>
                    <option value="PACIENTE">üë§ Paciente</option>
                  </select>
                </div>
              </div>

              <!-- IPRESS (solo para IPRESS_ADMIN) -->
              <div class="col-md-6" *ngIf="showIpressField">
                <div class="form-group">
                  <label for="ipress_id" class="form-label">
                    <i class="bi bi-building me-2"></i>
                    IPRESS
                    <span class="required">*</span>
                  </label>
                  <select 
                    class="form-select form-control-modern" 
                    id="ipress_id" 
                    formControlName="ipress_id"
                    [ngClass]="{'is-invalid': ipressIdControl?.invalid && ipressIdControl?.touched}"
                  >
                    <option [ngValue]="null">Seleccione una IPRESS</option>
                    <option *ngFor="let item of ipress" [value]="item.id">{{ item.nombre }}</option>
                  </select>
                  <div class="invalid-feedback" *ngIf="ipressIdControl?.errors?.['required']">
                    <i class="bi bi-exclamation-circle me-1"></i>
                    Debe seleccionar una IPRESS
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Seguridad -->
          <div class="form-section">
            <div class="section-header">
              <h4 class="section-title">
                <i class="bi bi-key me-2"></i>
                Seguridad
              </h4>
              <p class="section-description">Contrase√±a y configuraciones de seguridad</p>
            </div>
            
            <div class="row g-4">
              <!-- Contrase√±a -->
              <div class="col-md-6">
                <div class="form-group">
                  <label for="contrasena" class="form-label">
                    <i class="bi bi-lock me-2"></i>
                    {{ isEditMode ? 'Nueva Contrase√±a' : 'Contrase√±a' }}
                    <span class="required" *ngIf="!isEditMode">*</span>
                  </label>
                  <input 
                    type="password" 
                    class="form-control form-control-modern" 
                    id="contrasena" 
                    formControlName="contrasena_hash"
                    [placeholder]="isEditMode ? 'Dejar en blanco para mantener la actual' : 'M√≠nimo 6 caracteres'"
                    [ngClass]="{'is-invalid': contrasenaControl?.invalid && contrasenaControl?.touched}"
                  >
                  <div class="invalid-feedback" *ngIf="contrasenaControl?.errors?.['required']">
                    <i class="bi bi-exclamation-circle me-1"></i>
                    La contrase√±a es obligatoria
                  </div>
                  <div class="invalid-feedback" *ngIf="contrasenaControl?.errors?.['minlength']">
                    <i class="bi bi-exclamation-circle me-1"></i>
                    La contrase√±a debe tener al menos 6 caracteres
                  </div>
                </div>
              </div>

              <!-- Estado -->
              <div class="col-md-6">
                <div class="form-group">
                  <label for="estado" class="form-label">
                    <i class="bi bi-toggle-on me-2"></i>
                    Estado
                    <span class="required">*</span>
                  </label>
                  <select 
                    class="form-select form-control-modern" 
                    id="estado" 
                    formControlName="estado_id"
                  >
                    <option *ngFor="let estado of estados" [value]="estado.id">{{ estado.nombre }}</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

        <!-- Acciones -->
        <div class="form-actions">
          <button type="button" class="btn btn-outline-secondary btn-modern" (click)="onCancel()">
            <i class="bi bi-arrow-left me-2"></i>
            Cancelar
          </button>
          <button type="submit" class="btn btn-primary btn-modern" [disabled]="usuarioForm.invalid || loading">
            <i class="bi bi-{{ isEditMode ? 'check-circle' : 'plus-circle' }} me-2"></i>
            {{ isEditMode ? 'Actualizar Usuario' : 'Crear Usuario' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>